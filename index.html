<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChatNova</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>
<body>
  <h1 class="center-heading">ChatNova</h1>
  <div id="login" class="text-center">
    <div class="btn btn-md btn-outline-primary mb-2" id="new" style="display: inline;">Create Chat Room</div>
    <div class="btn btn-md btn-outline-success mb-3" id="old" style="display: inline;">Join Chat Room</div>
    <input type="text" id="username" class="form-control mb-2 w-150 mx-auto" placeholder="Enter your name" required style="visibility:hidden;">
    <input type="text" id="chatId" class="form-control mb-2 w-150 mx-auto" placeholder="Enter chat ID (room)" style="visibility: hidden;">
    <button onclick="joinChat()" class="btn btn-primary" style="visibility: hidden;" id="join">Join Chat</button>\
    
  </div>
  <div id="chatUI" class="mt-4" style="display: none;">
    <h6 id="chatRoomHeader" class="text-center mb-3"></h6>
    <div id="chatBox" style="overflow:auto; border:1px solid #ccc;"></div>
    <div class="row mt-3">
      <div class="col-8">
        <input type="text" id="messageInput" placeholder="Type message..." class="form-control">
      </div>
      <div class="col-4">
        <button onclick="sendMessage()" class="btn btn-outline-primary w-100">Send</button>
      </div>
    </div>
    <button id="closeRoomBtn" class="btn btn-danger mt-3" style="display: none;" onclick="closeRoom()">Close Room</button>
    <br><br>
    <p style="font-size: 0.9rem;">*Share the chat ID with your friends to let them join the group</p>
  </div>
  <script>
    let socket;
    let username = '';
    let chatId = '';

    function joinChat() {
      username = document.getElementById('username').value.trim();
      chatId = document.getElementById('chatId').value.trim();
      document.getElementById('closeRoomBtn').style.display = 'block';
      if (!chatId) {
        chatId = 'chat_' + Math.random().toString(36).substring(2, 10);
      }

      socket = new WebSocket(location.origin.replace(/^http/, 'ws'));
      socket.onopen = () => {
        socket.send(JSON.stringify({ type: 'join', username, chatId }));
        document.getElementById('login').style.display = 'none';
        document.getElementById('chatUI').style.display = 'block';
        document.getElementById('chatRoomHeader').innerText = `Group Chat id: ${chatId}`;
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "room-closed") {
        alert("This room has been closed by the creator.");
        socket.close();
        location.reload();
        return;
      }
        const time = new Date(data.date).toLocaleTimeString([], {
          hour: '2-digit',
          minute: '2-digit',
          hour12: true
        });
        const isSelf = data.username === username;

        const card = `
          <div class="chat-message ${isSelf ? 'self' : ''}">
            <div class="message-content">
              <h6 class="username">${isSelf ? 'You' : data.username}</h6>
              <p class="text">${data.message}</p>
              <span class="time">${time}</span>
            </div>
          </div>
        `;
        document.getElementById('chatBox').innerHTML += card;
        document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
      };
    }
    function closeRoom() {
      if (socket && chatId) {
        socket.send(JSON.stringify({ type: "close-room", chatId }));
        alert("You closed the room.");
        socket.close();
        location.reload(); // Optional: refresh UI
      }
    }
    function sendMessage() {
      const input = document.getElementById('messageInput');
      const msg = input.value.trim();
      if (msg) {
        socket.send(JSON.stringify({ type: 'message', message: msg, chatId }));
        input.value = '';
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
  <script src="app.js"></script>
</body>
</html>

